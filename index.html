<!DOCTYPE html>
<html lang="id">
<head>
<meta http-equiv="Permissions-Policy" content="camera=*, microphone=*">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Scan Wajah</title>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'Segoe UI', sans-serif;
  background: #0f172a;
  color: #f8fafc;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.scan-container {
  position: relative;
  width: 280px;
  height: 280px;
  margin: 0 auto 20px;
}
.scan-circle {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  border: 3px solid #3b82f6;
  overflow: hidden;
  background: #000;
  box-shadow: 0 0 40px rgba(59,130,246,0.3);
}
video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transform: scaleX(-1);
}
.scan-line {
  position: absolute;
  width: 100%;
  height: 2px;
  background: #3b82f6;
  box-shadow: 0 0 10px #3b82f6;
  top: 50%;
  animation: scan 2s infinite ease-in-out;
  z-index: 10;
  pointer-events: none;
}
@keyframes scan {
  0% { top: 10%; opacity: 0; }
  50% { opacity: 1; }
  100% { top: 90%; opacity: 0; }
}
.status {
  text-align: center;
  font-size: 14px;
  color: #94a3b8;
  margin-bottom: 16px;
  min-height: 20px;
}
.status.success { color: #10b981; font-weight: 600; }
.status.error { color: #ef4444; }
.btn {
  width: 100%;
  max-width: 280px;
  padding: 14px;
  border-radius: 12px;
  border: none;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  transition: all 0.2s;
  background: #3b82f6;
  color: white;
  margin: 0 auto;
}
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.btn:not(:disabled):hover { background: #2563eb; transform: translateY(-1px); }
.loading-bar {
  width: 280px;
  height: 4px;
  background: #1e293b;
  border-radius: 4px;
  margin: 12px auto;
  overflow: hidden;
}
.loading-fill {
  height: 100%;
  background: #3b82f6;
  border-radius: 4px;
  width: 0%;
  transition: width 0.3s;
}
.label {
  font-size: 18px;
  font-weight: 700;
  text-align: center;
  margin-bottom: 6px;
}
.sublabel {
  font-size: 12px;
  color: #64748b;
  text-align: center;
  margin-bottom: 20px;
}
.fail-box {
  display: none;
  background: rgba(239,68,68,0.15);
  border: 1px solid #ef4444;
  border-radius: 10px;
  padding: 12px 16px;
  font-size: 13px;
  color: #ef4444;
  text-align: center;
  max-width: 280px;
  margin: 10px auto 0;
}
</style>
</head>
<body>

<div class="label" id="title">Scan Wajah</div>
<div class="sublabel" id="subtitle">Posisikan wajah Anda di tengah lingkaran</div>

<div class="scan-container">
  <div class="scan-circle">
    <video id="cam" autoplay playsinline muted></video>
    <div class="scan-line" id="scan-line"></div>
  </div>
</div>

<div class="loading-bar"><div class="loading-fill" id="load-bar"></div></div>
<div class="status" id="status">Memuat model AI...</div>

<button class="btn" id="scan-btn" disabled onclick="doScan()">
  ðŸ“· Ambil & Verifikasi Wajah
</button>

<div class="fail-box" id="fail-box">
  Wajah tidak terdeteksi atau tidak cocok.<br>Pastikan wajah terlihat jelas dan terang.
</div>

<script>
var faceDescriptorFromParent = null;
var faceLoaded = false;
var stream = null;
var actionType = '';
var empNik = '';

// Terima pesan dari Apps Script (parent)
window.addEventListener('message', function(event) {
  var data = event.data;
  if (!data || data.type !== 'init') return;

  // Simpan descriptor wajah karyawan dari parent
  faceDescriptorFromParent = data.descriptor ? new Float32Array(data.descriptor) : null;
  actionType = data.actionType || '';
  empNik = data.nik || '';

  document.getElementById('title').textContent = getTitleByType(actionType);
  document.getElementById('subtitle').textContent = 'ID: ' + empNik;
});

function getTitleByType(type) {
  var map = {
    masuk: 'Absen Masuk',
    pulang: 'Absen Pulang',
    istirahat_mulai: 'Mulai Istirahat',
    istirahat_selesai: 'Selesai Istirahat'
  };
  return map[type] || 'Scan Wajah';
}

// Load Face API models
function loadModels() {
  var bar = document.getElementById('load-bar');
  var status = document.getElementById('status');
  var progress = 0;
  var interval = setInterval(function() {
    progress = Math.min(progress + 2, 85);
    bar.style.width = progress + '%';
  }, 100);

  Promise.all([
    faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model'),
    faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model'),
    faceapi.nets.faceRecognitionNet.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model')
  ]).then(function() {
    clearInterval(interval);
    bar.style.width = '100%';
    faceLoaded = true;
    status.textContent = 'Model siap. Kamera aktif!';
    status.className = 'status success';
    document.getElementById('scan-btn').disabled = false;
  }).catch(function(err) {
    clearInterval(interval);
    status.textContent = 'Gagal memuat model AI.';
    status.className = 'status error';
  });
}

// Mulai kamera
function startCamera() {
  navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false })
    .then(function(s) {
      stream = s;
      document.getElementById('cam').srcObject = s;
      loadModels();
    })
    .catch(function(err) {
      document.getElementById('status').textContent = 'Gagal akses kamera: ' + err.message;
      document.getElementById('status').className = 'status error';
    });
}

// Lakukan scan wajah
function doScan() {
  if (!faceLoaded) return;
  var btn = document.getElementById('scan-btn');
  var status = document.getElementById('status');
  var failBox = document.getElementById('fail-box');
  failBox.style.display = 'none';
  btn.disabled = true;
  btn.textContent = 'â³ Memverifikasi...';
  status.textContent = 'Mendeteksi wajah...';
  status.className = 'status';

  var video = document.getElementById('cam');
  var canvas = document.createElement('canvas');
  canvas.width = video.videoWidth || 640;
  canvas.height = video.videoHeight || 480;
  canvas.getContext('2d').drawImage(video, 0, 0);

  faceapi.detectSingleFace(canvas, new faceapi.TinyFaceDetectorOptions())
    .withFaceLandmarks()
    .withFaceDescriptor()
    .then(function(detection) {
      if (!detection) {
        failBox.style.display = 'block';
        status.textContent = 'Wajah tidak terdeteksi. Coba lagi.';
        status.className = 'status error';
        btn.disabled = false;
        btn.textContent = 'ðŸ“· Ambil & Verifikasi Wajah';
        return;
      }

      // Verifikasi jarak wajah jika descriptor tersedia
      if (faceDescriptorFromParent) {
        var dist = faceapi.euclideanDistance(detection.descriptor, faceDescriptorFromParent);
        if (dist > 0.5) {
          failBox.style.display = 'block';
          failBox.textContent = 'Wajah tidak cocok! (dist: ' + dist.toFixed(2) + ')';
          status.textContent = 'Verifikasi gagal.';
          status.className = 'status error';
          btn.disabled = false;
          btn.textContent = 'ðŸ“· Ambil & Verifikasi Wajah';
          return;
        }
      }

      // Kompres foto
      var sm = document.createElement('canvas');
      sm.width = 300; sm.height = 300;
      sm.getContext('2d').drawImage(canvas, 0, 0, 300, 300);
      var photoDataUrl = sm.toDataURL('image/jpeg', 0.6);

      status.textContent = 'âœ… Verifikasi berhasil!';
      status.className = 'status success';
      btn.textContent = 'âœ… Berhasil';

      // Kirim hasil kembali ke parent (Apps Script)
      window.parent.postMessage({
        type: 'face_verified',
        photo: photoDataUrl,
        descriptor: Array.from(detection.descriptor)
      }, '*');

    }).catch(function(err) {
      status.textContent = 'Error: ' + err.message;
      status.className = 'status error';
      btn.disabled = false;
      btn.textContent = 'ðŸ“· Ambil & Verifikasi Wajah';
    });
}

// Start
window.addEventListener('load', function() {
  startCamera();
});
</script>
</body>
</html>
